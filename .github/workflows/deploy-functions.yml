name: Deploy Cloud Functions Gen2 (python only)

on:
  push:
    branches: ["main"]
    paths:
      - "functions/**"
      - ".github/workflows/deploy-functions.yml"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-functions-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: access_token
          access_token_lifetime: 600s

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy ocr-trigger (Gen2)
        run: |
          gcloud functions deploy ocr-trigger \
            --gen2 \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --region="${{ secrets.GCP_REGION }}" \
            --runtime=python310 \
            --timeout=120s \
            --min-instances=0 \
            --max-instances=30 \
            --concurrency=10 \
            --source=functions/ocr_trigger \
            --entry-point=start_ocr \
            --quiet

      - name: Deploy md-generator (Gen2)
        run: |
          gcloud functions deploy md-generator \
            --gen2 \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --region="${{ secrets.GCP_REGION }}" \
            --runtime=python310 \
            --source=functions/md_generator \
            --entry-point=generate_markdown \
            --quiet
